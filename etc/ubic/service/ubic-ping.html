<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>~/git/ubic/etc/ubic/service/ubic-ping.html</title>
<meta name="Generator" content="Vim/7.1">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#ffffff" text="#000000"><font face="monospace">
<font color="#8080ff"># vim:ft=perl</font><br>
<font color="#aaaa00">use </font>Ubic::Service::Common;<br>
<font color="#aaaa00">use </font>Ubic::Daemon <font color="#ff6060">qw(</font><font color="#ff6060">:all</font><font color="#ff6060">)</font>;<br>
<font color="#aaaa00">use </font>Yandex::Persistent;<br>
<font color="#aaaa00">use </font>LWP::Simple;<br>
<font color="#aaaa00">use </font>POSIX;<br>
<font color="#aaaa00">require</font>&nbsp;<font color="#ff6060">&quot;</font><font color="#ff6060">/usr/share/ubic/ubic-ping</font><font color="#ff6060">&quot;</font>;<br>
<br>
<font color="#aaaa00">my</font>&nbsp;<font color="#00aaaa">$port</font>&nbsp;= <font color="#ff6060">12345</font>;<br>
<font color="#aaaa00">my</font>&nbsp;<font color="#00aaaa">$pidfile</font>&nbsp;= <font color="#ff6060">&quot;</font><font color="#ff6060">/var/lib/ubic/ubic-ping.pid</font><font color="#ff6060">&quot;</font>;<br>
<br>
Ubic::Service::Common-&gt;new({<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">start</font>&nbsp;=&gt; <font color="#aaaa00">sub </font>{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#aaaa00">my</font>&nbsp;<font color="#00aaaa">$pid</font>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start_daemon({<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">function</font>&nbsp;=&gt; <font color="#aaaa00">sub </font>{ Ubic::Ping-&gt;new(<font color="#00aaaa">$port</font>)-&gt;run },<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">name</font>&nbsp;=&gt; <font color="#ff6060">'</font><font color="#ff6060">ubic-ping</font><font color="#ff6060">'</font>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">pidfile</font>&nbsp;=&gt; <font color="#00aaaa">$pidfile</font>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">stop</font>&nbsp;=&gt; <font color="#aaaa00">sub </font>{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stop_daemon(<font color="#00aaaa">$pidfile</font>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">status</font>&nbsp;=&gt; <font color="#aaaa00">sub </font>{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#aaaa00">unless</font>&nbsp;(check_daemon(<font color="#00aaaa">$pidfile</font>)) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#aaaa00">return</font>&nbsp;<font color="#ff6060">'</font><font color="#ff6060">not running</font><font color="#ff6060">'</font>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#aaaa00">my</font>&nbsp;<font color="#00aaaa">$result</font>&nbsp;= get(<font color="#ff6060">&quot;</font><font color="#ff6060"><a href="http://localhost:">http://localhost:</a></font><font color="#00aaaa">$port</font><font color="#ff6060">/ping</font><font color="#ff6060">&quot;</font>) || <font color="#ff6060">''</font>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#aaaa00">return</font>&nbsp;((<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#00aaaa">$result</font>&nbsp;=~ <font color="#aaaa00">/</font><font color="#ff6060">^ok$</font><font color="#aaaa00">/</font><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) ? <font color="#ff6060">'</font><font color="#ff6060">running</font><font color="#ff6060">'</font>&nbsp;: <font color="#ff6060">'</font><font color="#ff6060">broken</font><font color="#ff6060">'</font>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;},<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#ff6060">port</font>&nbsp;=&gt; <font color="#00aaaa">$port</font>,<br>
});<br>
</font></body>
</html>
